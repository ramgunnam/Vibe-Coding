<template>
    <lightning-card title="Data Quality Dashboard - Apex Cursors" icon-name="standard:data_integration_hub">
        <!-- Dashboard Stats Summary -->
        <div class="slds-p-around_medium">
            <div class="slds-grid slds-gutters slds-wrap">
                <!-- Critical Issues Card -->
                <div class="slds-col slds-size_1-of-4 slds-p-bottom_small">
                    <div class="stat-card critical">
                        <div class="stat-value">{stats.criticalIssues}</div>
                        <div class="stat-label">Critical Issues</div>
                    </div>
                </div>
                <!-- High Issues Card -->
                <div class="slds-col slds-size_1-of-4 slds-p-bottom_small">
                    <div class="stat-card high">
                        <div class="stat-value">{stats.highIssues}</div>
                        <div class="stat-label">High Priority</div>
                    </div>
                </div>
                <!-- Duplicates Card -->
                <div class="slds-col slds-size_1-of-4 slds-p-bottom_small">
                    <div class="stat-card warning">
                        <div class="stat-value">{stats.pendingDuplicates}</div>
                        <div class="stat-label">Pending Duplicates</div>
                    </div>
                </div>
                <!-- Quality Score Card -->
                <div class="slds-col slds-size_1-of-4 slds-p-bottom_small">
                    <div class="stat-card success">
                        <div class="stat-value">{formattedQualityScore}</div>
                        <div class="stat-label">Avg Quality Score</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Control Section -->
        <div class="slds-p-horizontal_medium slds-p-bottom_medium">
            <lightning-card title="Start New Job">
                <div class="slds-p-around_medium">
                    <div class="slds-grid slds-gutters">
                        <div class="slds-col slds-size_1-of-2">
                            <lightning-combobox
                                name="processingMode"
                                label="Processing Mode"
                                value={selectedMode}
                                placeholder="Select Processing Mode"
                                options={processingModes}
                                onchange={handleModeChange}>
                            </lightning-combobox>
                        </div>
                        <div class="slds-col slds-size_1-of-2 slds-align-bottom">
                            <lightning-button
                                variant="brand"
                                label="Start Data Quality Job"
                                onclick={handleStartJob}
                                disabled={isJobRunning}>
                            </lightning-button>
                        </div>
                    </div>
                </div>
            </lightning-card>
        </div>

        <!-- Active Job Progress -->
        <template if:true={activeJob}>
            <div class="slds-p-horizontal_medium slds-p-bottom_medium">
                <lightning-card title="Active Job Progress">
                    <div class="slds-p-around_medium">
                        <div class="slds-grid slds-gutters slds-wrap">
                            <!-- Overall Progress -->
                            <div class="slds-col slds-size_1-of-1 slds-p-bottom_medium">
                                <div class="slds-text-heading_small slds-p-bottom_x-small">
                                    Overall Progress: {overallProgressPercent}%
                                </div>
                                <lightning-progress-bar value={overallProgressPercent} size="large">
                                </lightning-progress-bar>
                            </div>

                            <!-- Accounts Progress -->
                            <div class="slds-col slds-size_1-of-2 slds-p-bottom_small">
                                <div class="progress-section">
                                    <div class="progress-header">
                                        <lightning-icon icon-name="standard:account" size="small"></lightning-icon>
                                        <span class="slds-p-left_x-small">Accounts</span>
                                    </div>
                                    <div class="progress-text">
                                        {activeJob.accountsProcessed} / {activeJob.totalAccounts}
                                    </div>
                                    <lightning-progress-bar value={accountProgressPercent} size="medium">
                                    </lightning-progress-bar>
                                </div>
                            </div>

                            <!-- Contacts Progress -->
                            <div class="slds-col slds-size_1-of-2 slds-p-bottom_small">
                                <div class="progress-section">
                                    <div class="progress-header">
                                        <lightning-icon icon-name="standard:contact" size="small"></lightning-icon>
                                        <span class="slds-p-left_x-small">Contacts</span>
                                    </div>
                                    <div class="progress-text">
                                        {activeJob.contactsProcessed} / {activeJob.totalContacts}
                                    </div>
                                    <lightning-progress-bar value={contactProgressPercent} size="medium">
                                    </lightning-progress-bar>
                                </div>
                            </div>

                            <!-- Opportunities Progress -->
                            <div class="slds-col slds-size_1-of-2 slds-p-bottom_small">
                                <div class="progress-section">
                                    <div class="progress-header">
                                        <lightning-icon icon-name="standard:opportunity" size="small"></lightning-icon>
                                        <span class="slds-p-left_x-small">Opportunities</span>
                                    </div>
                                    <div class="progress-text">
                                        {activeJob.opportunitiesProcessed} / {activeJob.totalOpportunities}
                                    </div>
                                    <lightning-progress-bar value={opportunityProgressPercent} size="medium">
                                    </lightning-progress-bar>
                                </div>
                            </div>

                            <!-- Cases Progress -->
                            <div class="slds-col slds-size_1-of-2 slds-p-bottom_small">
                                <div class="progress-section">
                                    <div class="progress-header">
                                        <lightning-icon icon-name="standard:case" size="small"></lightning-icon>
                                        <span class="slds-p-left_x-small">Cases</span>
                                    </div>
                                    <div class="progress-text">
                                        {activeJob.casesProcessed} / {activeJob.totalCases}
                                    </div>
                                    <lightning-progress-bar value={caseProgressPercent} size="medium">
                                    </lightning-progress-bar>
                                </div>
                            </div>

                            <!-- Job Metrics -->
                            <div class="slds-col slds-size_1-of-1 slds-p-top_medium">
                                <div class="slds-grid slds-gutters">
                                    <div class="slds-col">
                                        <div class="metric-box">
                                            <span class="metric-value">{activeJob.issuesFound}</span>
                                            <span class="metric-label">Issues Found</span>
                                        </div>
                                    </div>
                                    <div class="slds-col">
                                        <div class="metric-box">
                                            <span class="metric-value">{activeJob.duplicatesFound}</span>
                                            <span class="metric-label">Duplicates</span>
                                        </div>
                                    </div>
                                    <div class="slds-col">
                                        <div class="metric-box">
                                            <span class="metric-value">{activeJob.executionCount}</span>
                                            <span class="metric-label">Executions</span>
                                        </div>
                                    </div>
                                    <div class="slds-col">
                                        <div class="metric-box">
                                            <span class="metric-value">{activeJobQualityScore}</span>
                                            <span class="metric-label">Quality Score</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </lightning-card>
            </div>
        </template>

        <!-- Tabset for Issues, Duplicates, and Job History -->
        <div class="slds-p-horizontal_medium">
            <lightning-tabset>
                <!-- Data Quality Issues Tab -->
                <lightning-tab label="Data Quality Issues">
                    <div class="slds-p-around_medium">
                        <template if:true={issuesResult}>
                            <div class="slds-p-bottom_small">
                                <span class="slds-text-body_small">
                                    Showing page {issuesResult.currentPage} of {issuesResult.totalPages}
                                    ({issuesResult.totalRecords} total records)
                                </span>
                            </div>

                            <lightning-datatable
                                key-field="Id"
                                data={issuesResult.records}
                                columns={issueColumns}
                                hide-checkbox-column
                                onrowaction={handleIssueRowAction}>
                            </lightning-datatable>

                            <!-- Pagination Controls -->
                            <div class="slds-p-top_medium slds-grid slds-grid_align-center">
                                <lightning-button
                                    label="Previous"
                                    onclick={handleIssuesPrevious}
                                    disabled={disableIssuesPrevious}>
                                </lightning-button>
                                <div class="slds-p-horizontal_medium">
                                    <lightning-input
                                        type="number"
                                        label="Go to page"
                                        value={issuesResult.currentPage}
                                        min="1"
                                        max={issuesResult.totalPages}
                                        onchange={handleIssuesPageJump}>
                                    </lightning-input>
                                </div>
                                <lightning-button
                                    label="Next"
                                    onclick={handleIssuesNext}
                                    disabled={disableIssuesNext}>
                                </lightning-button>
                            </div>
                        </template>
                        <template if:false={issuesResult}>
                            <lightning-spinner alternative-text="Loading"></lightning-spinner>
                        </template>
                    </div>
                </lightning-tab>

                <!-- Duplicates Tab -->
                <lightning-tab label="Duplicate Records">
                    <div class="slds-p-around_medium">
                        <template if:true={duplicatesResult}>
                            <div class="slds-p-bottom_small">
                                <span class="slds-text-body_small">
                                    Showing page {duplicatesResult.currentPage} of {duplicatesResult.totalPages}
                                    ({duplicatesResult.totalRecords} total records)
                                </span>
                            </div>

                            <lightning-datatable
                                key-field="Id"
                                data={duplicatesResult.records}
                                columns={duplicateColumns}
                                hide-checkbox-column
                                onrowaction={handleDuplicateRowAction}>
                            </lightning-datatable>

                            <!-- Pagination Controls -->
                            <div class="slds-p-top_medium slds-grid slds-grid_align-center">
                                <lightning-button
                                    label="Previous"
                                    onclick={handleDuplicatesPrevious}
                                    disabled={disableDuplicatesPrevious}>
                                </lightning-button>
                                <div class="slds-p-horizontal_medium">
                                    <lightning-input
                                        type="number"
                                        label="Go to page"
                                        value={duplicatesResult.currentPage}
                                        min="1"
                                        max={duplicatesResult.totalPages}
                                        onchange={handleDuplicatesPageJump}>
                                    </lightning-input>
                                </div>
                                <lightning-button
                                    label="Next"
                                    onclick={handleDuplicatesNext}
                                    disabled={disableDuplicatesNext}>
                                </lightning-button>
                            </div>
                        </template>
                    </div>
                </lightning-tab>

                <!-- Job History Tab -->
                <lightning-tab label="Job History">
                    <div class="slds-p-around_medium">
                        <template if:true={jobsResult}>
                            <lightning-datatable
                                key-field="Id"
                                data={jobsResult.records}
                                columns={jobColumns}
                                hide-checkbox-column
                                onrowaction={handleJobRowAction}>
                            </lightning-datatable>

                            <!-- Pagination Controls -->
                            <div class="slds-p-top_medium slds-grid slds-grid_align-center">
                                <lightning-button
                                    label="Previous"
                                    onclick={handleJobsPrevious}
                                    disabled={disableJobsPrevious}>
                                </lightning-button>
                                <lightning-button
                                    label="Next"
                                    onclick={handleJobsNext}
                                    disabled={disableJobsNext}
                                    class="slds-m-left_small">
                                </lightning-button>
                            </div>
                        </template>
                    </div>
                </lightning-tab>
            </lightning-tabset>
        </div>
    </lightning-card>
</template>
